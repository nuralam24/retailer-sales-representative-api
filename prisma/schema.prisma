// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Region {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  areas     Area[]
  retailers Retailer[]

  @@map("regions")
}

model Area {
  id        Int      @id @default(autoincrement())
  name      String
  regionId  Int      @map("region_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  region      Region      @relation(fields: [regionId], references: [id], onDelete: Cascade)
  territories Territory[]
  retailers   Retailer[]

  @@index([regionId])
  @@map("areas")
}

model Distributor {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  retailers Retailer[]

  @@map("distributors")
}

model Territory {
  id        Int      @id @default(autoincrement())
  name      String
  areaId    Int      @map("area_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  area      Area       @relation(fields: [areaId], references: [id], onDelete: Cascade)
  retailers Retailer[]

  @@index([areaId])
  @@map("territories")
}

model Retailer {
  id            Int      @id @default(autoincrement())
  uid           String   @unique @db.VarChar(50)
  name          String   @db.VarChar(255)
  phone         String   @db.VarChar(20)
  regionId      Int      @map("region_id")
  areaId        Int      @map("area_id")
  distributorId Int      @map("distributor_id")
  territoryId   Int      @map("territory_id")
  points        Int      @default(0)
  routes        String?  @db.Text
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  region      Region              @relation(fields: [regionId], references: [id])
  area        Area                @relation(fields: [areaId], references: [id])
  distributor Distributor         @relation(fields: [distributorId], references: [id])
  territory   Territory           @relation(fields: [territoryId], references: [id])
  assignments SalesRepRetailer[]

  @@index([uid])
  @@index([regionId])
  @@index([areaId])
  @@index([distributorId])
  @@index([territoryId])
  @@index([phone])
  @@map("retailers")
}

enum UserRole {
  admin
  sales_rep
}

model SalesRep {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(100)
  name         String   @db.VarChar(255)
  phone        String   @db.VarChar(20)
  passwordHash String   @map("password_hash")
  role         UserRole @default(sales_rep)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  assignments SalesRepRetailer[]

  @@map("sales_reps")
}

model SalesRepRetailer {
  salesRepId Int      @map("sales_rep_id")
  retailerId Int      @map("retailer_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  salesRep SalesRep @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@id([salesRepId, retailerId])
  @@index([salesRepId])
  @@index([retailerId])
  @@map("sales_rep_retailers")
}

